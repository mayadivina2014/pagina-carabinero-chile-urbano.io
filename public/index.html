<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chile Urbano</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="icon" href="/images/Logo_pagina.png" type="image/png">
</head>
<body>
    <header class="top-bar">
        <h1>
            <img src="/images/Logo_pagina.png" alt="Logo Chile Urbano">
            Chile Urbano
        </h1>
        <a href="/auth/discord" class="btn-discord-login">
            <img src="/images/discord_logo.png" alt="Discord Logo" style="height: 20px; margin-right: 8px;">
            Iniciar sesi√≥n con Discord
        </a>
    </header>

    <div class="main-content-wrapper">
        <main class="main-card">
            <h2>Bienvenido a Chile Urbano</h2>
            <p class="tagline">La plataforma integral para la gesti√≥n de veh√≠culos y ciudadanos.</p>

            <section class="auth-call-to-action">
                <h3>Acceso Restringido</h3>
                <p>Para acceder a las funciones completas de la plataforma (registro, b√∫squeda avanzada, gesti√≥n de multas, etc.), debes iniciar sesi√≥n con tu cuenta de Discord. Esto garantiza la seguridad y la autenticaci√≥n de los usuarios autorizados.</p>
                <a href="/auth/discord" class="btn-discord-cta">
                    <img src="/images/discord_logo.png" alt="Discord Logo" style="height: 24px; margin-right: 10px;">
                    Iniciar sesi√≥n con Discord
                </a>
            </section>

            <section class="public-info-section">
                <h3>Informaci√≥n P√∫blica Reciente <span class="public-info-icon">üõ°Ô∏è</span></h3>
                <p class="public-info-description">Explora los √∫ltimos datos p√∫blicos registrados en el sistema, como veh√≠culos a√±adidos recientemente, personas buscadas y las multas m√°s recientes.</p>

                <div class="data-display-grid">
                    <div class="data-block">
                        <h4>√öltimos Veh√≠culos Registrados</h4>
                        <ul id="recent-vehicles-list">
                            <li>Cargando veh√≠culos...</li>
                        </ul>
                    </div>
                    <div class="data-block">
                        <h4>Personas Buscadas</h4>
                        <ul id="wanted-people-list">
                            <li>Cargando personas...</li>
                        </ul>
                    </div>
                    <div class="data-block">
                        <h4>√öltimas Multas</h4>
                        <ul id="recent-fines-list">
                            <li>Cargando multas...</li>
                        </ul>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Funci√≥n para formatear fechas
            const formatDate = (dateString) => {
                if (!dateString) return 'N/A';
                try {
                    const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                    return new Date(dateString).toLocaleDateString('es-ES', options);
                } catch (e) {
                    return dateString; // Devuelve la cadena original si hay error
                }
            };

            // Funci√≥n para cargar veh√≠culos recientes
            const loadRecentVehicles = async () => {
                const listElement = document.getElementById('recent-vehicles-list');
                try {
                    const response = await fetch('/api/public/recent-vehicles');
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Error ${response.status}: ${errorText}`);
                    }
                    const vehicles = await response.json();
                    listElement.innerHTML = ''; // Limpiar el mensaje de carga

                    if (vehicles.length === 0) {
                        listElement.innerHTML = '<li>No hay veh√≠culos recientes.</li>';
                        return;
                    }

                    vehicles.forEach(vehicle => {
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>${vehicle.marca} ${vehicle.modelo}</strong><br>
                                        Patente: ${vehicle.patente}<br>
                                        A√±o: ${vehicle.anio || 'N/A'}<br>
                                        Registro: ${formatDate(vehicle.fechaRegistro)}`;
                        listElement.appendChild(li);
                    });
                } catch (error) {
                    console.error('Error al cargar veh√≠culos recientes:', error);
                    listElement.innerHTML = `<li>Error al cargar veh√≠culos: ${error.message}</li>`;
                }
            };

            // Funci√≥n para cargar personas buscadas
            const loadWantedPeople = async () => {
                const listElement = document.getElementById('wanted-people-list');
                try {
                    const response = await fetch('/api/public/wanted-people');
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Error ${response.status}: ${errorText}`);
                    }
                    const people = await response.json();
                    listElement.innerHTML = ''; // Limpiar el mensaje de carga

                    if (people.length === 0) {
                        listElement.innerHTML = '<li>No hay personas buscadas.</li>';
                        return;
                    }

                    people.forEach(person => {
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>${person.nombreCompleto}</strong><br>
                                        RUT: ${person.rut || 'N/A'}<br>
                                        Motivo: ${person.motivo_busqueda || 'N/A'}`;
                        listElement.appendChild(li);
                    });
                } catch (error) {
                    console.error('Error al cargar personas buscadas:', error);
                    listElement.innerHTML = `<li>Error al cargar personas: ${error.message}</li>`;
                }
            };

            // Funci√≥n para cargar √∫ltimas multas
            const loadRecentFines = async () => {
                const listElement = document.getElementById('recent-fines-list');
                try {
                    const response = await fetch('/api/public/recent-fines');
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Error ${response.status}: ${errorText}`);
                    }
                    const fines = await response.json();
                    listElement.innerHTML = ''; // Limpiar el mensaje de carga

                    if (fines.length === 0) {
                        listElement.innerHTML = '<li>No hay multas recientes.</li>';
                        return;
                    }

                    fines.forEach(fine => {
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>${fine.motivo}</strong><br>
                                        Patente: ${fine.patente || 'N/A'}<br>
                                        Monto: $${fine.monto ? fine.monto.toLocaleString('es-CL') : 'N/A'}<br>
                                        Fecha: ${formatDate(fine.fecha)}`;
                        if (fine.propietario && fine.propietario.nombreCompleto) {
                            li.innerHTML += `<br>Propietario: ${fine.propietario.nombreCompleto}`;
                        }
                        listElement.appendChild(li);
                    });
                } catch (error) {
                    console.error('Error al cargar √∫ltimas multas:', error);
                    listElement.innerHTML = `<li>Error al cargar multas: ${error.message}</li>`;
                }
            };

            // Cargar datos al inicio
            loadRecentVehicles();
            loadWantedPeople();
            loadRecentFines();
        });
    </script>
</body>
</html>